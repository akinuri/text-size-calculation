<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Text Size Calculator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style type="text/tailwindcss">
        @layer utilities {
            .cell-border :is(td, th) {
                @apply border;
            }
            .cell-px-2 :is(td, th) {
                @apply px-2;
            }
            .cell-py-1 :is(td, th) {
                @apply py-1;
            }
            .cell-border-slate-300 :is(td, th) {
                @apply border-slate-300;
            }
        }
    </style>
</head>
<body class="bg-slate-200 p-4">

<div class="flex flex-col gap-4 items-start text-slate-700">
    <div>
        <span class="inline-block w-24">Font Family</span>
        <div class="inline-flex gap-3 items-center">
            <select id="local-fonts" class="p-2 rounded shadow" data-placeholder="Select a font">
                <option class="text-gray-400">Select a font</option>
                <option selected style="font-family: Arial, sans-serif;">Arial</option>
            </select>
            <button
                class="bg-slate-50 rounded px-3 py-1 shadow hover:bg-slate-100 active:bg-slate-100/70"
                onclick="loadLocalFonts(this)"
                >
                Load Local Fonts
            </button>
        </div>
    </div>
    <div>
        <span class="inline-block w-24">Uppercase</span>
        <input
            type="text"
            class="px-2 py-1 border border-slate-300 w-96 rounded"
            value="ABCDEFGHIJKLMNOPQRSTUVWXYZ"
            id="uppercase-letters"
            >
    </div>
    <div>
        <span class="inline-block w-24">Lowercase</span>
        <input
            type="text"
            class="px-2 py-1 border border-slate-300 w-96 rounded"
            value="abcdefghijklmnopqrstuvwxyz"
            id="lowercase-letters"
            >
    </div>
    <div>
        <span class="inline-block w-24">Digits</span>
        <input
            type="text"
            class="px-2 py-1 border border-slate-300 w-96 rounded"
            value="0123456789"
            id="digits"
            >
    </div>
    <div>
        <span class="inline-block w-24">Other</span>
        <input
            type="text"
            class="px-2 py-1 border border-slate-300 w-96 rounded"
            value="&nbsp;,;:.!?&quot;'+-*/\<&gt;=%()[]{}^`~_|@#&$â‚¬"
            id="other-chars"
            >
    </div>
</div>

<hr class="my-4 border-slate-300">

<div id="letters-container" class="flex flex-col gap-4 font-[Arial] text-[50px] leading-none">
    <div class="flex items-center gap-4" id="uppercase-container"></div>
    <div class="flex items-center gap-4" id="lowercase-container"></div>
    <div class="flex items-center gap-4" id="digits-container"></div>
    <div class="flex items-center gap-4" id="other-container"></div>
</div>

<hr class="my-4 border-slate-300">

<div class="flex gap-4 items-start text-slate-700">
    <button
        class="bg-slate-50 rounded px-3 py-1 shadow hover:bg-slate-100 active:bg-slate-100/70"
        onclick="printCharWidthRatios()"
        >
        Calculate Widths
    </button>
</div>

<hr class="my-4 border-slate-300">

<div class="flex flex-col gap-4 items-start">
    
    <div class="flex items-start">
        <span class="inline-block mr-4">Enter text to test</span>
        <div
            class="bg-white shadow outline-dashed w-fit min-w-[2rem] max-w-[30rem] outline-1 outline-slate-400 leading-none mt-1"
            contenteditable
            ></div>
    </div>
    
    <table class="cell-border cell-border-slate-300 cell-px-2 cell-py-1 bg-white/50">
        <thead>
            <tr>
                <th></th>
                <th>HTML</th>
                <th>Calculated</th>
                <th>Match (%)</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Width</td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td>Height</td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td>Lines</td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        </tbody>
    </table>
    
</div>

<script>
    let localFontsEl = document.querySelector("#local-fonts");
    
    let lettersContainer = document.querySelector("#letters-container");
    
    let uppercaseContainer  = document.querySelector("#uppercase-container");
    let lowercaseContainer  = document.querySelector("#lowercase-container");
    let digitsContainer     = document.querySelector("#digits-container");
    let otherContainer      = document.querySelector("#other-container");
    
    let uppercaseLettersBox = document.querySelector("#uppercase-letters");
    let lowercaseLettersBox = document.querySelector("#lowercase-letters");
    let digitsBox           = document.querySelector("#digits");
    let otherCharsBox       = document.querySelector("#other-chars");
    
    localFontsEl.addEventListener("change", () => {
        let value = localFontsEl.value;
        if (value == localFontsEl.dataset.placeholder) {
            value = "";
        }
        lettersContainer.style.fontFamily = value;
    });
    
    uppercaseLettersBox.addEventListener("input", printUppercaseLetters);
    lowercaseLettersBox.addEventListener("input", printLowercaseLetters);
    digitsBox.addEventListener("input", printDigits);
    otherCharsBox.addEventListener("input", printOtherCharacters);
    [
        uppercaseLettersBox,
        lowercaseLettersBox,
        digitsBox,
        otherCharsBox,
    ].forEach(el => el.dispatchEvent(new Event("input")));
    
    // #region ==================== FUNCTIONS
    
    async function loadLocalFonts(callerBtn) {
        let fonts = await getFontData();
        if (fonts.length == 0) {
            return;
        }
        localFontsEl.lastElementChild.remove();
        Object.keys(fonts).forEach(family => {
            let selected = "";
            if (family == "Arial") {
                selected = " selected";
            }
            localFontsEl.innerHTML += `
                <option${selected} style="font-family: '${family}'">${family}</option>
            `;
        });
        callerBtn.remove();
    }
    async function getFontData() {
        try {
            let fonts = await window.queryLocalFonts();
            let fontFamilies = groupByProperty(fonts, "family");
            return fontFamilies;
        } catch (err) {
            console.error(err.name, err.message);
        }
    }
    function groupByProperty(arr, property) {
        return arr.reduce((acc, obj) => {
            const key = obj[property];
            if (!acc[key]) {
                acc[key] = [];
            }
            acc[key].push(obj);
            return acc;
        }, {});
    }
    
    function printUppercaseLetters() {
        uppercaseContainer.innerHTML = "";
        uppercaseLettersBox.value.split("").forEach(letter => {
            uppercaseContainer.innerHTML += `<div class="bg-white shadow">${letter}</div>`;
        });
    }
    function printLowercaseLetters() {
        lowercaseContainer.innerHTML = "";
        lowercaseLettersBox.value.split("").forEach(letter => {
            lowercaseContainer.innerHTML += `<div class="bg-white shadow">${letter}</div>`;
        });
    }
    function printDigits() {
        digitsContainer.innerHTML = "";
        digitsBox.value.split("").forEach(digit => {
            digitsContainer.innerHTML += `<div class="bg-white shadow">${digit}</div>`;
        });
    }
    function printOtherCharacters() {
        otherContainer.innerHTML = "";
        otherCharsBox.value.split("").forEach(letter => {
            otherContainer.innerHTML += `<div class="bg-white shadow">${letter}</div>`;
        });
    }
    
    function printCharWidthRatios() {
        let charWidthRatios = calculateCharWidthRatios();
        let containers = {
            uppercase : uppercaseContainer,
            lowercase : lowercaseContainer,
            digit     : digitsContainer,
            other     : otherContainer,
        };
        for (let containerName in containers) {
            let containerEl = containers[containerName];
            for (let charEl of Array.from(containerEl.children)) {
                let char = charEl.textContent.trim();
                if (char == "") {
                    char = " ";
                }
                charEl.title = charWidthRatios[containerName][char];
                charEl.classList.add("shadow", "shadow-sky-500/50");
            }
        }
    }
    
    function calculateCharWidthRatios() {
        let charWidths = {
            uppercase : {},
            lowercase : {},
            digit     : {},
            other     : {},
        };
        let containers = {
            uppercase : uppercaseContainer,
            lowercase : lowercaseContainer,
            digit     : digitsContainer,
            other     : otherContainer,
        };
        for (let containerName in containers) {
            let containerEl = containers[containerName];
            for (let charEl of Array.from(containerEl.children)) {
                let char   = charEl.textContent.trim();
                if (char == "") {
                    char = " ";
                }
                let width  = getComputedStyle(charEl).width;
                let height = getComputedStyle(charEl).height;
                width  = parseFloat(width);
                height = parseFloat(height);
                let widthRatio = width / height;
                charWidths[containerName][char] = widthRatio;
            }
        }
        return charWidths;
    }
    
    //#endregion
    
</script>

</body>
</html>